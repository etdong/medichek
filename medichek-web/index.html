<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Medichek - Medication Application Tracker</title>
    <link rel="stylesheet" href="./static/style.css">
    
    <!-- MediaPipe Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <!-- Tesseract.js for OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <!-- JSZip for creating zip files -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    
    <!-- AWS SDK for S3 (MinIO compatible) -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.24.min.js"></script>
    
    <!-- Environment Variables (optional - copy env.example.js to env.js) -->
    <script src="./env.js" onerror="console.log('env.js not found - using defaults from config.js')"></script>
    
    <!-- Medichek Configuration -->
    <script src="./static/config.js"></script>
</head>
<body>
    <div class="container">
        <!-- Status Bar -->
        <div class="status-panel">
            <div class="status-item">
                <span class="status-label">Server:</span>
                <span id="server-status" class="status-badge checking">Checking...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Session:</span>
                <span id="session-id" class="status-value">None</span>
            </div>
            <div class="status-item">
                <span class="status-label">Step:</span>
                <span id="current-step" class="status-value">0/5</span>
            </div>
        </div>

        <!-- Captured Frame Preview Area (Always visible - attached to status bar) -->
        <div id="captured-frame-area" class="captured-frame-area empty">
            <div class="captured-frame-content">
                <div class="captured-frames-grid">
                    <!-- Step 3: Product Label Capture -->
                    <div class="frame-slot" id="step3-frame-slot">
                        <div class="frame-header">
                            <span class="frame-label">Step 1</span>
                            <span id="ocr-status" class="ocr-status"></span>
                        </div>
                        <canvas id="step3-frame-canvas" class="frame-canvas"></canvas>
                        <div id="ocr-result-compact" class="ocr-result-compact"></div>
                    </div>
                    
                    <!-- Step 4: Palm Detection Capture -->
                    <div class="frame-slot" id="step4-frame-slot">
                        <div class="frame-header">
                            <span class="frame-label">Step 2</span>
                            <span id="palm-status" class="palm-status"></span>
                        </div>
                        <canvas id="step4-frame-canvas" class="frame-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Spacer for fixed status bar + captured frame area -->
        <div class="status-spacer"></div>

        <!-- Main content wrapper (centered vertically) -->
        <div class="main-content-wrapper">
            <!-- Step Status Container (fixed height wrapper) -->
            <div class="step-status-container">
                <div class="step-status-overlay" id="step-status-overlay">
                    <div id="step-instruction" class="step-instruction">Ready to begin</div>
                    <div id="step-progress" class="step-progress"></div>
                </div>
            </div>
            
            <!-- Video Feed Container -->
            <div class="video-container">
                <video id="webcam" autoplay playsinline></video>
                <canvas id="output-canvas"></canvas>
                
                <!-- Countdown Overlay -->
                <div id="countdown-overlay" class="countdown-overlay">
                    <div id="countdown-number" class="countdown-number">3</div>
                </div>
                
                <!-- Warning Toast -->
                <div id="warning-toast" class="warning-toast">
                    <span class="toast-icon">⚠️</span>
                    <span class="toast-message">Please keep your face in the center frame</span>
                </div>
                
                <!-- Hand Out of Bounds Warning -->
                <div id="hand-bounds-warning" class="hand-bounds-warning">
                    <span class="warning-icon">⚠️</span>
                    <span class="warning-text">Keep hand in frame</span>
                </div>
            </div>

            <!-- Action Button Container -->
            <div class="action-button-container">
                <button id="start-tracking" class="btn btn-primary">Start</button>
                <button id="next-step" class="btn btn-primary" style="display: none;">Next Step</button>
                <button id="capture-frame" class="btn btn-primary" style="display: none;">Manual Capture</button>
                <button id="submit-analysis" class="btn btn-success" style="display: none;">Submit Analysis</button>
            </div>
        </div>

        <!-- OCR Fail Modal -->
        <div id="ocr-fail-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-icon">⚠️</span>
                    <h3 class="modal-title">Product Label Not Recognized</h3>
                </div>
                <div class="modal-body">
                    <p>The automatic verification could not detect the product label the captured image.</p>
                    <p><strong>What would you like to do?</strong></p>
                    <ul>
                        <li><strong>Retry:</strong> Capture a new image with better lighting or positioning</li>
                        <li><strong>Continue:</strong> Submit the image for manual review</li>
                    </ul>
                </div>
                <div class="modal-actions">
                    <button id="retry-ocr" class="btn btn-primary">Retry Capture</button>
                    <button id="continue-anyway" class="btn btn-secondary">Continue</button>
                </div>
            </div>
        </div>
        
        <!-- OCR Analysis Overlay -->
        <div id="ocr-analysis-overlay" class="ocr-analysis-overlay" style="display: none;">
            <div class="ocr-analysis-content">
                <div class="ocr-spinner"></div>
                <div class="ocr-analysis-text">Analyzing product label...</div>
            </div>
        </div>
        
        <!-- Upload Overlay -->
        <div id="upload-overlay" class="upload-overlay" style="display: none;">
            <div class="upload-content">
                <div class="upload-spinner"></div>
                <div class="upload-text">Uploading session data...</div>
                <div class="upload-progress">Please wait, do not close this window</div>
            </div>
        </div>
        
        <!-- Download Overlay -->
        <div id="download-overlay" class="upload-overlay" style="display: none;">
            <div class="upload-content">
                <div class="upload-spinner"></div>
                <div class="upload-text">Generating zip file...</div>
                <div class="upload-progress">Please wait, preparing your download</div>
            </div>
        </div>
        
        <!-- Completion Screen -->
        <div id="completion-screen" class="completion-screen" style="display: none;">
            <div class="completion-content">
                <div id="completion-icon" class="completion-icon"></div>
                <h2 id="completion-title" class="completion-title">Upload Complete</h2>
                <p id="completion-message" class="completion-message"></p>
                <div id="completion-details" class="completion-details"></div>
                <button id="start-new-session-btn" class="btn btn-primary">Start New Session</button>
            </div>
        </div>
    </div>

    <script src="./static/script.js"></script>
</body>
</html>
